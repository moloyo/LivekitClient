### Signaling API

This repo implements a simple signaling API that will be used for Pradco Surveillance Cams live streaming using Livekit.

## Quick Start guide

You will need to install all dependencies, run:

```
npm install
```

To compile the TypeScript code into JavaScript, run:

```
npm run build
```

This will store all the compiled code on the `dist` folder

Set environment variables either in your OS or the provided [.env](./.env) file:

- LIVEKIT_API_KEY: The API Key configured in the deployment of Livekit server
- LIVEKIT_API_SECRET: The API Secret configured in the deployment of Livekit server
- CAMERA_NAME: Name of the camera (optional)
- CAMERA_ROOM_NAME: Room where the camera joins
- CAMERA_DEVICE_URL: URL to control the camera
- LIVEKIT_SERVER_URL: URL of the Livekit Server
- SERVICE_PORT: Port where this API will run (defaults to 3000)

After setting up the environment variables you can trigger the development server by running:

```
npm run dev
```

This command will run with [Concurrently](https://www.npmjs.com/package/concurrently) and [Nodemon](https://www.npmjs.com/package/nodemon) to detect  file changes and automatically restart the server.

## Build a Docker Image

A [Dockerfile](./Dockerfile) is provided to containerize this API, you can create an image by running the command (mind the dot at the end of the command):

```
docker build -t signaling .
```

Observer that we asssume you have Docker installed locally, to start the container you can run the command (replace description betweeen {} by corresponding values):

```
docker run \
    -e LIVEKIT_API_KEY={provide-api-key} \
    -e LIVEKIT_API_SECRET={provide-api-secret} \
    -e CAMERA_NAME=cam01 \
    -e CAMERA_ROOM_NAME=Camera_1 \
    -e CAMERA_DEVICE_URL={provide-cam-control-url} \
    -e LIVEKIT_SERVER_URL={provide-livekit-server-url} \
    -p 3000:8080 signaling:latest
```

This will expose the service on the 8080 port of your host.

## Deplyment to K8S

We assume you have already installed kubectl and you are connected to a cluster, also, that you've pusshed your image to a registry that is accesible from your cluster. The [signaling.yaml](./signaling.yaml) file is a config that can be used to deploy your API in kubernetes. Replace the placeholder values for image URL and environment variables, then run the command:

```
kubectl create -f signaling.yaml
```

you must see the pods and replicaset created by the deployment and a Service acting as LoadBalancer which is assigned an external IP. Observe that we expose the service externally in the port 80 which is HTTP, if you want to use HTTPS you must configure your cluster and service accordingly, *This deployment is provided for testing purposes and in no way is suited for a production environmnet*.

## Using the API

Once you have the signaling API running you can use the following methods:

# Activate camera

```
Method: POST
path: /viewcamera/CAM_ID (CAM_ID is irrelevant as per Aug 2023, but a value must be provided)
body:
{
    "user_name": "YOUR USER NAME"
}

response:
{
    "status": true,
    "camName": "Same CAM_ID provided",
    "roomName": "Camera_1",
    "livekitToken": "BASE64 TOKEN TO CONNECT TO LIVEKIT",
    "livekitServerUrl": "LIVEKIT URL TO CONNECT TO"
}
```

# Start Recording

```
Method: POST
path: /startrecording
body:
{
    "user_id": "YOUR USER NAME",
	"room": "Camera_1",
	"track_ids": ["TR_VXXXXX", "TR_AYYYYY"]
}

response:
{
    "status": true
	"egress_id": "ID OF THE EGRESS CREATED FOR RECORDING",
	"room_id": "INTERNAL LIVEKIT ROOM ID",
	"error": "IF ANY"
}
```
Observe that Video and Audio Track IDs must be provided, those values are generated by Livekit when the camera starts publishing audio/video.

# Stop Recording

```
Method: POST
path: /stoprecording
body:
{
	"egress_id": "THE SAME VALUE RETURNED BY START RECORDING"
}

response:
{
    "status": true
	"egress_id": "ID OF THE EGRESS CREATED FOR RECORDING",
	"room_id": "INTERNAL LIVEKIT ROOM ID",
	"error": "IF ANY"
}
```
